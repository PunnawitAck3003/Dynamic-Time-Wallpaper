<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Time Wallpaper</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;600&family=Charm:wght@700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Kanit', sans-serif;
        }

        /* Background Layer */
        #bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: background-image 1.5s ease-in-out, opacity 1s ease;
            z-index: 0;
            transform: scale(1.1);
            animation: breathe 60s infinite alternate linear;
        }

        @keyframes breathe {
            0% { transform: scale(1.1) translate(0, 0); }
            50% { transform: scale(1.15) translate(-10px, -5px); }
            100% { transform: scale(1.1) translate(0, 0); }
        }

        /* Overlay */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: background 2s ease;
            z-index: 1;
            background: radial-gradient(circle, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.6) 100%);
        }

        /* Content Container */
        #content {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            text-align: center;
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 2.5rem 4rem;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 340px;
            max-width: 90%;
            transition: all 0.3s ease;
        }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 100;
            white-space: nowrap;
        }

        #toast.show {
            opacity: 1;
        }

        /* Control Buttons (Sound & Fullscreen) */
        .control-btn {
            position: absolute;
            top: 20px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        #fullscreen-btn { right: 20px; }
        #sound-toggle { right: 80px; }

        /* Typography */
        #time {
            font-size: 8rem;
            font-weight: 600;
            line-height: 1;
            letter-spacing: 2px;
            font-variant-numeric: tabular-nums;
            margin: 10px 0;
        }

        #date {
            font-size: 1.5rem;
            font-weight: 300;
            opacity: 0.9;
        }

        /* Weather Styles */
        #weather {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 8px 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 300;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.5s ease;
        }
        
        #weather.visible {
            opacity: 1;
            transform: translateY(0);
        }

        #weather-icon { font-size: 1.5rem; }

        #greeting {
            font-size: 1.8rem;
            font-weight: 200;
            font-family: 'Charm', cursive;
            color: #ffecd2;
            margin-top: 20px;
        }

        /* Quote Styles */
        #quote-container {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
            width: 100%;
            max-width: 500px;
        }

        #quote-text {
            font-size: 1.1rem;
            font-weight: 300;
            font-style: italic;
            opacity: 0.9;
            line-height: 1.5;
        }

        #quote-author {
            font-size: 0.9rem;
            margin-top: 5px;
            opacity: 0.6;
            font-weight: 400;
            display: block;
        }

        /* Selector */
        .selector-container {
            margin-bottom: 1.5rem;
            position: relative;
        }

        select {
            appearance: none;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            border-radius: 99px;
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            outline: none;
            text-align: center;
            transition: background 0.3s;
            min-width: 280px;
        }

        select:hover { background: rgba(0, 0, 0, 0.5); }
        
        .select-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }

        option { background: #222; color: white; }

        /* Canvas */
        #particle-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            #time { font-size: 4.5rem; }
            #date { font-size: 1.1rem; }
            #greeting { font-size: 1.4rem; }
            .glass-panel { padding: 2rem; width: 90%; }
            #fullscreen-btn { top: 10px; right: 10px; width: 40px; height: 40px; }
            #sound-toggle { top: 10px; right: 60px; width: 40px; height: 40px; }
        }
    </style>
</head>
<body>

    <div id="toast"></div>

    <button id="sound-toggle" class="control-btn" onclick="toggleSound()" title="Music On/Off">
        <svg id="icon-mute" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v6a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="8" y1="2" x2="8" y2="2"></line><line x1="12" y1="2" x2="12" y2="2"></line><line x1="16" y1="2" x2="16" y2="2"></line><line x1="11" y1="1" x2="11" y2="1"></line><line x1="15" y1="1" x2="15" y2="1"></line></svg>
        <svg id="icon-sound" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
    </button>

    <button id="fullscreen-btn" class="control-btn" onclick="toggleFullScreen()" title="Full Screen">
        <svg id="icon-maximize" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
        <svg id="icon-minimize" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
    </button>

    <div id="bg-layer"></div>
    <div id="overlay"></div>
    <canvas id="particle-canvas"></canvas>

    <div id="content">
        <div class="glass-panel">
            <div class="selector-container">
                <select id="country-select" onchange="handleCountryChange()">
                    <option value="th">üáπüá≠ ‡πÑ‡∏ó‡∏¢ (Bangkok)</option>
                    <option value="jp">üáØüáµ ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô (Tokyo)</option>
                    <option value="uk">üá¨üáß ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (London)</option>
                    <option value="us_ny">üá∫üá∏ ‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤ (New York)</option>
                    <option value="us_la">üá∫üá∏ ‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤ (Los Angeles)</option>
                </select>
                <span class="select-arrow">‚ñº</span>
            </div>
            
            <div id="time">00:00:00</div>
            <div id="date">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            
            <div id="weather">
                <span id="weather-icon"></span>
                <span id="weather-temp">--¬∞C</span>
                <span id="weather-desc"></span>
            </div>

            <div id="greeting">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö</div>

            <div id="quote-container">
                <span id="quote-text">"..."</span>
                <span id="quote-author"></span>
            </div>
        </div>
    </div>

    <script>
        // EXPANDED: Multiple Backgrounds per period for variety
        const backgrounds = {
            morning: [
                "https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?q=80&w=2070&auto=format&fit=crop", // Misty Hills
                "https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=2070&auto=format&fit=crop", // Sunrise Field
                "https://images.unsplash.com/photo-1544866635-714041793776?q=80&w=2070&auto=format&fit=crop", // Morning Coffee/Light
                "https://images.unsplash.com/photo-1495908333960-5e1b3b9fa0ac?q=80&w=2070&auto=format&fit=crop", // Sun through trees
                "https://images.unsplash.com/photo-1504198266287-1659872e6590?q=80&w=2070&auto=format&fit=crop", // Calm Morning Water
                "https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2070&auto=format&fit=crop"  // Bright Morning
            ],
            afternoon: [
                "https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2070&auto=format&fit=crop", // Mountain Lake
                "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=2070&auto=format&fit=crop", // Green Hills
                "https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?q=80&w=2070&auto=format&fit=crop", // Foggy Forest
                "https://images.unsplash.com/photo-1501854140884-074cf2b2c3af?q=80&w=2070&auto=format&fit=crop", // Beach Day
                "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2070&auto=format&fit=crop", // Sunlight Forest
                "https://images.unsplash.com/photo-1426604966848-d7adac402bff?q=80&w=2070&auto=format&fit=crop"  // Vast Landscape
            ],
            evening: [
                "https://images.unsplash.com/photo-1472120435266-53113306b2a2?q=80&w=2070&auto=format&fit=crop", // Orange Sunset
                "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2070&auto=format&fit=crop", // Beach Sunset
                "https://images.unsplash.com/photo-1616036740227-bb462729930f?q=80&w=2070&auto=format&fit=crop", // Pink Sky
                "https://images.unsplash.com/photo-1505322022379-7c3353ee6291?q=80&w=2000&auto=format&fit=crop", // Night lamp evening
                "https://images.unsplash.com/photo-1414609245224-afa02bfb3fda?q=80&w=2000&auto=format&fit=crop", // Autumn Evening
                "https://images.unsplash.com/photo-1514477917009-389c76a86b68?q=80&w=2000&auto=format&fit=crop"  // City Dusk
            ],
            night: [
                "https://images.unsplash.com/photo-1531306728370-e2ebd9d7bb99?q=80&w=1887&auto=format&fit=crop", // Galaxy
                "https://images.unsplash.com/photo-1519681393798-3828fb4090bb?q=80&w=2070&auto=format&fit=crop", // Aurora
                "https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?q=80&w=2070&auto=format&fit=crop", // Milky Way
                "https://images.unsplash.com/photo-1506318137071-a8bcbf67cc77?q=80&w=2070&auto=format&fit=crop", // City Night
                "https://images.unsplash.com/photo-1475274047050-1d0c0975c63e?q=80&w=2072&auto=format&fit=crop", // Night Sky
                "https://images.unsplash.com/photo-1507502907551-6b614d91284e?q=80&w=2070&auto=format&fit=crop"  // Dark Forest
            ]
        };

        // NEW: Hybrid Audio System (Local Files > Online Fallback)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ä‡∏∑‡πà‡∏≠ 'sounds' ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÑ‡∏ü‡∏•‡πå .mp3 ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
        const audioLibrary = {
            morning: {
                local: "sounds/morning.mp3",
                online: "https://upload.wikimedia.org/wikipedia/commons/transcoded/7/77/Bird_sound.ogg/Bird_sound.ogg.mp3"
            },
            afternoon: {
                local: "sounds/afternoon.mp3",
                online: "https://www.soundjay.com/nature/sounds/river-1.mp3"
            },
            evening: {
                local: "sounds/evening.mp3",
                online: "https://www.soundjay.com/nature/sounds/ocean-wave-1.mp3"
            },
            night: {
                local: "sounds/night.mp3",
                online: "https://www.soundjay.com/nature/sounds/cricket-2.mp3"
            }
        };

        const greetings = {
            morning: "‡∏≠‡∏£‡∏∏‡∏ì‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡πâ‡∏≤",
            afternoon: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢",
            evening: "‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏¢‡∏≤‡∏°‡πÄ‡∏¢‡πá‡∏ô",
            night: "‡∏£‡∏≤‡∏ï‡∏£‡∏µ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå"
        };

        const quotes = [
            { text: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏ô", author: "" },
            { text: "‡∏≠‡∏¢‡πà‡∏≤‡∏£‡∏≠‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ ‡πÅ‡∏ï‡πà‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏≠‡∏Å‡∏≤‡∏™", author: "" },
            { text: "‡∏ó‡∏∏‡∏Å‡πÄ‡∏ä‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", author: "" },
            { text: "‡∏ó‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡∏°‡∏±‡∏ô‡πÄ‡∏≠‡∏á", author: "" },
            { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
            { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { text: "Dream big and dare to fail.", author: "Norman Vaughan" },
            { text: "‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏î‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à ‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏î‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏à‡∏î‡∏à‡∏≥", author: "" },
            { text: "‡∏à‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏•‡∏Å‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏∏‡∏ì", author: "" },
            { text: "‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏Ñ‡∏∑‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏∞‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢", author: "" }
        ];

        const locations = {
            th: { timezone: 'Asia/Bangkok', lat: 13.7563, long: 100.5018 },
            jp: { timezone: 'Asia/Tokyo', lat: 35.6762, long: 139.6503 },
            uk: { timezone: 'Europe/London', lat: 51.5074, long: -0.1278 },
            us_ny: { timezone: 'America/New_York', lat: 40.7128, long: -74.0060 },
            us_la: { timezone: 'America/Los_Angeles', lat: 34.0522, long: -118.2437 }
        };

        const timeEl = document.getElementById('time');
        const dateEl = document.getElementById('date');
        const greetingEl = document.getElementById('greeting');
        const bgLayer = document.getElementById('bg-layer');
        const overlay = document.getElementById('overlay');
        const countrySelect = document.getElementById('country-select');
        const weatherEl = document.getElementById('weather');
        const weatherIconEl = document.getElementById('weather-icon');
        const weatherTempEl = document.getElementById('weather-temp');
        const weatherDescEl = document.getElementById('weather-desc');
        const quoteTextEl = document.getElementById('quote-text');
        const quoteAuthorEl = document.getElementById('quote-author');
        const maximizeIcon = document.getElementById('icon-maximize');
        const minimizeIcon = document.getElementById('icon-minimize');
        const toastEl = document.getElementById('toast');
        const soundBtn = document.getElementById('sound-toggle');
        const muteIcon = document.getElementById('icon-mute');
        const soundIcon = document.getElementById('icon-sound');

        let currentPeriod = '';
        
        // --- Audio Controls ---
        let isMuted = true;
        let audioPlayer = new Audio();
        audioPlayer.loop = true;
        audioPlayer.volume = 0.5;
        let usingLocalFile = true; // Track if we are currently trying local file
        
        // Error Handling & Fallback System
        let hasLoggedError = false;

        audioPlayer.onerror = function() {
            if (isMuted) return;
            
            // If error occurred while trying local file, switch to online
            if (usingLocalFile && currentPeriod && audioLibrary[currentPeriod]) {
                console.warn(`Local file not found: ${audioLibrary[currentPeriod].local}. Switching to online source.`);
                usingLocalFile = false; // Flag that we switched
                
                // Try playing the online source
                const onlineSrc = audioLibrary[currentPeriod].online;
                if (audioPlayer.src !== onlineSrc) {
                    audioPlayer.src = onlineSrc;
                    audioPlayer.play().catch(e => console.warn("Online fallback auto-play blocked:", e));
                }
                return;
            }

            // If we are already using online source and it fails, then log error
            if(!hasLoggedError) {
                console.error("Audio Load Error. Source:", audioPlayer.src);
                showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ (Network/Format Error)");
                
                isMuted = true;
                audioPlayer.pause();
                muteIcon.style.display = 'block';
                soundIcon.style.display = 'none';
                soundBtn.style.background = 'rgba(0,0,0,0.5)';
                hasLoggedError = true;
            }
        };

        function toggleSound() {
            isMuted = !isMuted;
            hasLoggedError = false; 

            if (isMuted) {
                audioPlayer.pause();
                muteIcon.style.display = 'block';
                soundIcon.style.display = 'none';
                soundBtn.style.background = 'rgba(0,0,0,0.5)';
                showToast("‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
            } else {
                // When turning on sound, try local file first (reset preference)
                usingLocalFile = true;
                playAtmosphereSound(currentPeriod);
                muteIcon.style.display = 'none';
                soundIcon.style.display = 'block';
                soundBtn.style.background = 'rgba(255,255,255,0.2)';
                showToast("‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®");
            }
        }

        function playAtmosphereSound(period) {
            if (isMuted || !period) return;
            
            const sources = audioLibrary[period];
            if(!sources) return;

            // Determine which source to use based on our current state
            const targetSrc = usingLocalFile ? sources.local : sources.online;
            
            // Only change src if it's different
            if (audioPlayer.src.indexOf(targetSrc) === -1 && targetSrc !== audioPlayer.src) {
                audioPlayer.src = targetSrc;
                audioPlayer.load(); 
                const playPromise = audioPlayer.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        hasLoggedError = false;
                        // If we successfully played local, keep usingLocalFile = true
                    })
                    .catch(error => {
                        // If play failed immediately (and it wasn't just auto-play block), 
                        // onerror might trigger, or we catch it here.
                        console.warn("Play attempt failed:", error);
                    });
                }
            } else if (audioPlayer.paused) {
                 const playPromise = audioPlayer.play();
                 if (playPromise !== undefined) {
                    playPromise.catch(error => console.warn("Auto-play prevented:", error));
                 }
            }
        }

        function showToast(message) {
            toastEl.textContent = message;
            toastEl.classList.add('show');
            setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {}).catch(err => {
                    console.warn(`Error: ${err.message}`);
                    showToast("‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Preview");
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                maximizeIcon.style.display = 'none';
                minimizeIcon.style.display = 'block';
            } else {
                maximizeIcon.style.display = 'block';
                minimizeIcon.style.display = 'none';
            }
        });

        function updateQuote() {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            const quote = quotes[randomIndex];
            quoteTextEl.textContent = `"${quote.text}"`;
            quoteAuthorEl.textContent = quote.author ? `- ${quote.author}` : '';
        }

        function getWeatherDescription(code) {
            const codes = {
                0: { text: "‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡πÅ‡∏à‡πà‡∏°‡πÉ‡∏™", icon: "‚òÄÔ∏è" },
                1: { text: "‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô", icon: "üå§Ô∏è" },
                2: { text: "‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô", icon: "üå§Ô∏è" },
                3: { text: "‡∏°‡∏µ‡πÄ‡∏°‡∏Ü‡∏°‡∏≤‡∏Å", icon: "‚òÅÔ∏è" },
                45: { text: "‡∏´‡∏°‡∏≠‡∏Å", icon: "üå´Ô∏è" },
                48: { text: "‡∏´‡∏°‡∏≠‡∏Å", icon: "üå´Ô∏è" },
                51: { text: "‡∏ù‡∏ô‡∏õ‡∏£‡∏≠‡∏¢‡πÜ", icon: "üåßÔ∏è" },
                53: { text: "‡∏ù‡∏ô‡∏õ‡∏£‡∏≠‡∏¢‡πÜ", icon: "üåßÔ∏è" },
                55: { text: "‡∏ù‡∏ô‡∏õ‡∏£‡∏≠‡∏¢‡πÜ", icon: "üåßÔ∏è" },
                61: { text: "‡∏ù‡∏ô‡∏ï‡∏Å", icon: "üåßÔ∏è" },
                63: { text: "‡∏ù‡∏ô‡∏ï‡∏Å‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", icon: "üåßÔ∏è" },
                65: { text: "‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å", icon: "‚õàÔ∏è" },
                80: { text: "‡∏ù‡∏ô‡πÇ‡∏õ‡∏£‡∏¢‡∏õ‡∏£‡∏≤‡∏¢", icon: "üå¶Ô∏è" },
                81: { text: "‡∏ù‡∏ô‡∏ï‡∏Å‡∏´‡∏ô‡∏±‡∏Å", icon: "‚õàÔ∏è" },
                95: { text: "‡∏û‡∏≤‡∏¢‡∏∏‡∏ù‡∏ô‡∏ü‡πâ‡∏≤‡∏Ñ‡∏∞‡∏ô‡∏≠‡∏á", icon: "‚ö°" }
            };
            return codes[code] || { text: "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏", icon: "üå°Ô∏è" };
        }

        async function fetchWeather(lat, long) {
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${long}&current=temperature_2m,weather_code`);
                const data = await response.json();
                
                if (data.current) {
                    const temp = Math.round(data.current.temperature_2m);
                    const code = data.current.weather_code;
                    const weatherInfo = getWeatherDescription(code);

                    weatherTempEl.textContent = `${temp}¬∞C`;
                    weatherIconEl.textContent = weatherInfo.icon;
                    weatherDescEl.textContent = weatherInfo.text;
                    weatherEl.classList.add('visible');
                }
            } catch (error) {
                console.error("Weather fetch error:", error);
                weatherEl.classList.remove('visible');
            }
        }

        function handleCountryChange() {
            // Force period check to trigger potential random background change if period is same
            currentPeriod = ''; // Reset period so updateClock forces a refresh
            
            updateClock();
            const selectedCountry = countrySelect.value;
            const loc = locations[selectedCountry];
            fetchWeather(loc.lat, loc.long);
            updateQuote(); 
        }

        function updateClock() {
            const selectedCountry = countrySelect.value;
            const loc = locations[selectedCountry];
            const targetTimezone = loc.timezone;

            const now = new Date();
            const targetDateString = now.toLocaleString("en-US", { timeZone: targetTimezone });
            const targetDate = new Date(targetDateString);

            const hours = String(targetDate.getHours()).padStart(2, '0');
            const minutes = String(targetDate.getMinutes()).padStart(2, '0');
            const seconds = String(targetDate.getSeconds()).padStart(2, '0');
            timeEl.textContent = `${hours}:${minutes}:${seconds}`;

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateEl.textContent = targetDate.toLocaleDateString('th-TH', options);

            const h = targetDate.getHours();
            let newPeriod = 'night';
            
            if (h >= 5 && h < 12) newPeriod = 'morning';
            else if (h >= 12 && h < 17) newPeriod = 'afternoon';
            else if (h >= 17 && h < 20) newPeriod = 'evening';
            else newPeriod = 'night';

            if (newPeriod !== currentPeriod) {
                changeAtmosphere(newPeriod);
                currentPeriod = newPeriod;
                if (!isMuted) {
                    playAtmosphereSound(newPeriod);
                }
            }
        }

        function changeAtmosphere(period) {
            // Get array of images for the period
            const periodImages = backgrounds[period];
            // Pick a random image from the array
            const randomIndex = Math.floor(Math.random() * periodImages.length);
            const imgUrl = periodImages[randomIndex];
            
            const img = new Image();
            img.src = imgUrl;
            img.onload = () => {
                bgLayer.style.backgroundImage = `url('${imgUrl}')`;
            };
            greetingEl.textContent = greetings[period];
            updateParticles(period);
        }

        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let particleColor = 'rgba(255, 255, 255, 0.5)';

        function updateParticles(period) {
            if (period === 'night') {
                particleColor = 'rgba(255, 255, 255, 0.8)';
                overlay.style.background = 'rgba(0, 0, 30, 0.5)';
            } else if (period === 'evening') {
                particleColor = 'rgba(255, 200, 100, 0.6)';
                overlay.style.background = 'rgba(60, 20, 0, 0.3)';
            } else if (period === 'morning') {
                particleColor = 'rgba(255, 255, 200, 0.4)';
                overlay.style.background = 'rgba(50, 50, 0, 0.1)';
            } else {
                particleColor = 'rgba(255, 255, 255, 0.3)';
                overlay.style.background = 'rgba(0, 0, 0, 0.15)';
            }
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;
                this.opacity = Math.random();
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                if (this.y < 0) this.y = canvas.height;
            }

            draw() {
                ctx.fillStyle = particleColor;
                ctx.globalAlpha = this.opacity;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < 100; i++) {
                particles.push(new Particle());
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
            }
            requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        initParticles();
        animateParticles();
        
        handleCountryChange(); 
        setInterval(updateClock, 1000);
        setInterval(updateQuote, 30000);

    </script>
</body>
</html>